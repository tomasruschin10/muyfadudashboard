<main class="px-sm-5 px-4 py-5">
  <!-- VISTA DE EDICIÓN DE CARRERA (se muestra cuando editMode es true) -->
  <section class="view" *ngIf="editMode">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3>Editar Carrera</h3>
      <button class="btn btn-secondary" (click)="clearEditMode()">
        <i class="fas fa-arrow-left me-2"></i>Volver
      </button>
    </div>

    <div class="card">
      <div class="card-body">
        <form [formGroup]="careerForm" class="row g-3">
          <!-- Nombre de la carrera -->
          <div class="col-md-6">
            <label for="edit-name" class="form-label">Nombre</label>
            <input type="text" class="form-control" id="edit-name" formControlName="name" placeholder="Nombre de la carrera">
            <div *ngIf="careerForm.get('name')?.touched && careerForm.get('name')?.errors?.required" class="text-danger mt-1">
              <small>El nombre es requerido</small>
            </div>
          </div>

          <!-- URL de descripción (opcional) -->
          <div class="col-md-6">
            <label for="edit-descriptionUrl" class="form-label">URL de descripción (opcional)</label>
            <input type="url" class="form-control" id="edit-descriptionUrl" formControlName="descriptionUrl" placeholder="https://ejemplo.com/descripcion">
          </div>

          <!-- Imagen de la carrera -->
          <div class="col-12">
            <label for="edit-careerImage" class="form-label">Imagen</label>
            <div class="image-preview-container border rounded-3 overflow-hidden" style="width: 100%; height: 300px; position: relative;">
              <ng-container *ngIf="selectedImageUrl; else noEditImage">
                <div class="w-100 h-100 d-flex align-items-center justify-content-center overflow-hidden">
                  <img [src]="selectedImageUrl" 
                       alt="Vista previa de la carrera" 
                       style="max-width: 100%; max-height: 100%; object-fit: cover;">
                </div>
              </ng-container>
              <ng-template #noEditImage>
                <div class="d-flex justify-content-center align-items-center h-100 bg-light">
                  <span class="text-muted">Sin imagen</span>
                </div>
              </ng-template>
              <div class="position-absolute bottom-0 end-0 m-2">
                <label for="edit-careerFile" class="btn btn-sm btn-primary">
                  <i class="fas fa-upload me-1"></i>{{ selectedImageUrl ? 'Cambiar' : 'Subir' }} imagen
                </label>
                <input type="file" id="edit-careerFile" accept="image/*" (change)="onImageSelected($event)" hidden>
              </div>
            </div>
            <div *ngIf="careerForm.get('image')?.touched && careerForm.get('image')?.errors?.required" class="text-danger mt-1">
              <small>La imagen es requerida</small>
            </div>
          </div>

          <!-- Botones de acción -->
          <div class="col-12 mt-4">
            <button type="button" class="btn btn-secondary me-2" (click)="clearEditMode()">Cancelar</button>
            <button type="button" class="btn btn-primary" (click)="updateCareer()" [disabled]="careerForm.invalid || loading">
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
              Guardar cambios
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="mt-2">
      <app-career-levels [careerId]="careerId || 0" [facultyId]="facultyId" [levels]="subjectCategories" (levelPayload)="createCategory($event)" (levelToDelete)="deleteCategory($event)" (reloadTrigger)="reloadCategories()">
  
      </app-career-levels>
    </div>
  </section>

  <!-- VISTA DE LISTA DE CARRERAS (se muestra cuando editMode es false) -->
  <section class="view" *ngIf="!editMode">
    <!-- Encabezado con título y botón de nueva carrera -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Carreras</h3>
      <button
        class="btn btn-primary"
        (click)="openCareerModal()"
      >
        Nueva carrera
      </button>
    </div>

    <!-- Tabla de carreras -->
    <div class="table-responsive">
      <table class="table align-middle text-center">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Accion</th>
          </tr>
        </thead>
        <tbody>
          <!-- Mensaje cuando no hay carreras o está cargando -->
          <tr *ngIf="loading">
            <td colspan="2" class="text-center py-4">
              <div class="d-flex justify-content-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
              </div>
            </td>
          </tr>
          <tr *ngIf="!loading && careers.length === 0">
            <td colspan="2" class="text-center py-4">
              <div class="alert alert-info mb-0">
                <i class="fas fa-info-circle me-2"></i>
                No hay carreras disponibles para la facultad seleccionada
              </div>
            </td>
          </tr>
          
          <!-- Listado de carreras -->
          <tr *ngFor="let item of careers | slice : (page - 1) * 10 : page * 10; let i = index">
            <td>{{ item.name }}</td>
            <td>
              <div class="d-flex gap-2 justify-content-center">
                <button
                  class="btn btn-1"
                  (click)="editCareer(item.id)"
                >
                  Ver
                </button>
                <button
                  class="btn btn-danger"
                  (click)="delete(item.id, i + (page - 1) * 10)"
                >
                  Eliminar
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Paginación -->
    <ngb-pagination
      *ngIf="careers.length > 0"
      [(page)]="page"
      [pageSize]="10"
      [maxSize]="5"
      [collectionSize]="careers.length"
    ></ngb-pagination>
  </section>
</main>

<!-- Template para el modal de creación de carrera -->
<ng-template #careerModal>
  <div class="modal-header">
    <h4 class="modal-title">Nueva Carrera</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="closeCareerModal()"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="careerForm">
      <!-- Nombre de la carrera -->
      <div class="mb-3">
        <label for="name" class="form-label">Nombre</label>
        <input type="text" class="form-control" id="name" formControlName="name" placeholder="Nombre de la carrera">
        <div *ngIf="careerForm.get('name')?.touched && careerForm.get('name')?.errors?.required" class="text-danger mt-1">
          <small>El nombre es requerido</small>
        </div>
      </div>

      <!-- URL de descripción (opcional) -->
      <div class="mb-3">
        <label for="descriptionUrl" class="form-label">URL de descripción (opcional)</label>
        <input type="url" class="form-control" id="descriptionUrl" formControlName="descriptionUrl" placeholder="https://ejemplo.com/descripcion">
      </div>

      <!-- Imagen de la carrera -->
      <div class="mb-3">
        <label for="careerImage" class="form-label">Imagen <span class="text-danger">*</span></label>
        <div class="image-preview-container border rounded-3 overflow-hidden" style="width: 100%; height: 200px; position: relative;">
          <ng-container *ngIf="selectedImageUrl; else noImage">
            <div class="w-100 h-100 d-flex align-items-center justify-content-center overflow-hidden">
              <img [src]="selectedImageUrl" 
                   alt="Vista previa de la carrera" 
                   style="max-width: 100%; max-height: 100%; object-fit: cover;">
            </div>
          </ng-container>
          <ng-template #noImage>
            <div class="d-flex justify-content-center align-items-center h-100 bg-light">
              <span class="text-muted">Sin imagen</span>
            </div>
          </ng-template>
          <div class="position-absolute bottom-0 end-0 m-2">
            <label for="careerFile" class="btn btn-sm btn-primary">
              <i class="fas fa-upload me-1"></i>Subir imagen
            </label>
            <input type="file" id="careerFile" accept="image/*" (change)="onImageSelected($event)" hidden>
          </div>
        </div>
        <div *ngIf="careerForm.get('image')?.touched && careerForm.get('image')?.errors?.required" class="text-danger mt-1">
          <small>La imagen es requerida</small>
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeCareerModal()">Cancelar</button>
    <button type="button" class="btn btn-primary" (click)="createCareer()" [disabled]="careerForm.invalid || loading">
      <span *ngIf="loading" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
      Guardar
    </button>
  </div>
</ng-template>