<div class="modal-header bg-gradient-primary text-white">
  <h4 class="modal-title d-flex align-items-center">
    <i class="fas fa-book-open me-2"></i>
    {{ editMode ? 'Editar materia' : 'Agregar materias al nivel' }}
  </h4>
  <button type="button" class="btn-close btn-close-white" aria-label="Close" (click)="close()"></button>
</div>

<div class="modal-body">
  <!-- Formulario para agregar materias -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light py-3">
      <h5 class="mb-0 fw-bold text-primary">
        <i class="fas fa-plus-circle me-2"></i>Nueva materia
      </h5>
    </div>
    <div class="card-body">
      <form [formGroup]="subjectForm" (ngSubmit)="addSubject()" class="mb-0">
        <div class="row g-3">
          <!-- Nombre de la materia -->
          <div class="col-md-6">
            <label for="name" class="form-label">Nombre de la materia *</label>
            <div class="input-group">
              <span class="input-group-text bg-light">
                <i class="fas fa-font"></i>
              </span>
              <input 
                type="text" 
                class="form-control" 
                id="name" 
                formControlName="name" 
                placeholder="Ej: Matemática I"
                [ngClass]="{'is-invalid': subjectForm.get('name')?.invalid && subjectForm.get('name')?.touched}"
              >
              <div class="invalid-feedback">
                El nombre es requerido
              </div>
            </div>
          </div>
          
          <!-- Prefijo -->
          <div class="col-md-3">
            <label for="prefix" class="form-label">Prefijo *</label>
            <div class="input-group">
              <span class="input-group-text bg-light">
                <i class="fas fa-tag"></i>
              </span>
              <input 
                type="text" 
                class="form-control" 
                id="prefix" 
                formControlName="prefix" 
                placeholder="Ej: MAT1"
                [ngClass]="{'is-invalid': subjectForm.get('prefix')?.invalid && subjectForm.get('prefix')?.touched}"
              >
              <div class="invalid-feedback">
                El prefijo es requerido
              </div>
            </div>
          </div>
          
          <!-- Etiqueta -->
          <div class="col-md-3">
            <label for="label" class="form-label">Etiqueta *</label>
            <div class="input-group">
              <span class="input-group-text bg-light">
                <i class="fas fa-bookmark"></i>
              </span>
              <input 
                type="text" 
                class="form-control" 
                id="label" 
                formControlName="label" 
                placeholder="Ej: Materia Regular"
                [ngClass]="{'is-invalid': subjectForm.get('label')?.invalid && subjectForm.get('label')?.touched}"
              >
              <div class="invalid-feedback">
                La etiqueta es requerida
              </div>
            </div>
          </div>
          
          <!-- URL -->
          <div class="col-md-6">
            <label for="url" class="form-label">URL (opcional)</label>
            <div class="input-group">
              <span class="input-group-text bg-light">
                <i class="fas fa-link"></i>
              </span>
              <input 
                type="url" 
                class="form-control" 
                id="url" 
                formControlName="url" 
                placeholder="https://ejemplo.com/materia"
              >
            </div>
          </div>
          
          <!-- Descripción -->
          <div class="col-md-6">
            <label for="info" class="form-label">Descripción (opcional)</label>
            <div class="input-group">
              <span class="input-group-text bg-light">
                <i class="fas fa-info-circle"></i>
              </span>
              <input 
                type="text" 
                class="form-control" 
                id="info" 
                formControlName="info" 
                placeholder="Breve descripción de la materia"
              >
            </div>
          </div>
          
          <!-- Cátedras (profesores) -->
          <div class="col-12">
            <label class="form-label">
              <i class="fas fa-chalkboard-teacher me-1"></i>
              Cátedras (profesores)
            </label>
            <div formArrayName="chairs" class="mb-2">
              <div *ngFor="let chair of chairsArray.controls; let i = index" class="input-group mb-2">
                <span class="input-group-text bg-light">
                  <i class="fas fa-user-tie"></i>
                </span>
                <input 
                  type="text" 
                  class="form-control" 
                  [formControlName]="i" 
                  placeholder="Nombre del profesor"
                >
                <button 
                  type="button" 
                  class="btn btn-outline-danger" 
                  (click)="removeChair(i)" 
                  *ngIf="chairsArray.length > 1"
                  title="Eliminar cátedra"
                >
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary" (click)="addChair()">
              <i class="fas fa-plus me-1"></i> Agregar cátedra
            </button>
          </div>

          <!-- Materias correlativas -->
          <div class="col-12 mt-3">
            <label class="form-label">
              <i class="fas fa-project-diagram me-1"></i>
              Materias correlativas
            </label>
            
            <div class="card">
              <div class="card-body p-3">
                <p class="text-muted small mb-3">
                  Seleccione las materias que deben ser aprobadas antes de cursar esta materia.
                </p>
                
                <!-- Si no hay materias disponibles -->
                <div *ngIf="subjectsCareer.length === 0" class="alert alert-info py-2 mb-0">
                  <i class="fas fa-info-circle me-2"></i>
                  No hay materias disponibles para seleccionar como correlativas.
                </div>
                
                <!-- Búsqueda de correlativas -->
                <div *ngIf="subjectsCareer.length > 0" class="mb-3">
                  <div class="input-group">
                    <span class="input-group-text bg-light">
                      <i class="fas fa-search"></i>
                    </span>
                    <input 
                      type="text" 
                      class="form-control" 
                      placeholder="Buscar materias..." 
                      [(ngModel)]="subjectParentSearch" 
                      [ngModelOptions]="{standalone: true}"
                    >
                  </div>
                </div>
                
                <!-- Lista de materias disponibles con filtro -->
                <div *ngIf="subjectsCareer.length > 0" class="d-flex flex-wrap gap-2">
                  <div *ngFor="let subject of filteredSubjectParents" class="form-check form-check-inline">
                    <input 
                      class="form-check-input" 
                      type="checkbox" 
                      [id]="'correlative-' + subject.id" 
                      [checked]="isSubjectParentSelected(subject.id)"
                      (change)="toggleSubjectParent(subject)"
                    >
                    <label class="form-check-label" [for]="'correlative-' + subject.id">
                      {{ subject.name }}
                    </label>
                  </div>
                </div>
                
                <!-- Materias correlativas seleccionadas -->
                <div *ngIf="subjectParentArray.length > 0" class="mt-3">
                  <label class="form-label text-primary">Correlativas seleccionadas:</label>
                  <div class="d-flex flex-wrap gap-2">
                    <span *ngFor="let parentId of subjectParentArray.value; let i = index" class="badge bg-primary d-flex align-items-center">
                      {{ getSubjectName(parentId) }}
                      <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.5rem;" (click)="removeSubjectParent(i)"></button>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Botón para agregar la materia -->
        <div class="d-flex justify-content-end mt-4">
          <button type="submit" class="btn btn-primary px-4" [disabled]="subjectForm.invalid">
            <i class="fas fa-plus-circle me-2"></i> Agregar a la lista
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Lista de materias agregadas -->
  <div *ngIf="subjects.length > 0" class="card shadow-sm">
    <div class="card-header bg-light py-3">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold text-primary">
          <i class="fas fa-list me-2"></i>
          Materias agregadas
        </h5>
        <span class="badge bg-primary rounded-pill">{{ subjects.length }}</span>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th class="text-center" style="width: 50px">#</th>
              <th>Nombre</th>
              <th>Prefijo</th>
              <th>Etiqueta</th>
              <th>Cátedras</th>
              <th class="text-center" style="width: 80px">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let subject of subjects; let i = index">
              <td class="text-center">{{ i + 1 }}</td>
              <td>{{ subject.name }}</td>
              <td><span class="badge bg-secondary">{{ subject.prefix }}</span></td>
              <td><span class="badge bg-info text-dark">{{ subject.label }}</span></td>
              <td>
                <div class="d-flex flex-wrap gap-1">
                  <span *ngFor="let chair of subject.chairs" class="badge bg-light text-dark border">
                    <i class="fas fa-user-tie me-1 text-secondary"></i>{{ chair }}
                  </span>
                </div>
              </td>
              <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeSubject(i)" title="Eliminar materia">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Mensaje cuando no hay materias -->
  <div *ngIf="subjects.length === 0" class="alert alert-info d-flex align-items-center mt-4">
    <i class="fas fa-info-circle fs-4 me-3"></i>
    <div>
      <strong>No hay materias agregadas.</strong> 
      <p class="mb-0">Complete el formulario y haga clic en "Agregar a la lista".</p>
    </div>
  </div>
</div>

<div class="modal-footer">
  <button type="button" class="btn btn-secondary" (click)="close()">
    <i class="fas fa-times me-2"></i>Cancelar
  </button>
  
  <!-- Botón de guardar con texto dinámico -->
  <button 
    type="button" 
    class="btn btn-primary"
    (click)="saveSubjects()"
    [disabled]="editMode ? subjectForm.invalid : subjects.length === 0"
  >
    <i class="fas fa-save me-2"></i>{{ editMode ? 'Guardar cambios' : 'Guardar materias' }}
  </button>
</div>